<h1>内存取证</h1>
<p>工具：Volatility2</p>
<p>软件可以通过github下载 需要配置python2与pip2环境</p>
<p><code>https://github.com/volatilityfoundation/volatility</code></p>
<p><img src="https://camo.githubusercontent.com/eeafeeaf1e41ff270b6f855ae44bfd1561649ae5395ca3a11c8c951cbc7ba58b/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f37613838393866636331623134623535623764343831306333306666353638392e706e67" alt="" /></p>
<p>如果系统为ArchLinux可以通过aur安装</p>
<p><code>yay python2-volatility</code></p>
<h2>工具使用方法</h2>
<table>
<thead>
<tr>
<th>命令</th>
<th>效果</th>
</tr>
</thead>
<tbody>
<tr>
<td>-f</td>
<td>引入镜像</td>
</tr>
<tr>
<td>imageinfo</td>
<td>查询镜像详细信息</td>
</tr>
<tr>
<td>--profile=sysinfo</td>
<td>使用何种配置文件</td>
</tr>
<tr>
<td>pslist</td>
<td>[插件]遍历内存镜像中的进程</td>
</tr>
<tr>
<td>procdump</td>
<td>[插件]提取内存镜像中的进程并且保存成文件</td>
</tr>
<tr>
<td>cmdscan</td>
<td>[插件]提取已执行的cmd命令</td>
</tr>
<tr>
<td>cmdline</td>
<td>[插件]提取命令行参数与参数值</td>
</tr>
<tr>
<td>filescan</td>
<td>[插件]查询已经打开的文件 获得详细信息</td>
</tr>
<tr>
<td>dumpfiles</td>
<td>[插件]提取系统内存中的文件</td>
</tr>
<tr>
<td>hashdump</td>
<td>[插件]提取系统内存中密码的hash值</td>
</tr>
<tr>
<td>mimikatz</td>
<td>[插件]直接提取内存中的明文密码</td>
</tr>
<tr>
<td>clipboard</td>
<td>[插件]提取剪贴板数据</td>
</tr>
<tr>
<td>svcscan</td>
<td>[插件]扫描进程中所有的服务</td>
</tr>
<tr>
<td>netscan</td>
<td>[插件]扫描内存中的网络连接和套接字</td>
</tr>
<tr>
<td>printkey</td>
<td>[插件]注册表分析_键值</td>
</tr>
<tr>
<td>hivelist</td>
<td>[插件]注册表分析_地址</td>
</tr>
<tr>
<td>hivedump</td>
<td>[插件]注册表分析_dump数据</td>
</tr>
<tr>
<td>timeliner</td>
<td>创建内存中的痕迹时间线</td>
</tr>
</tbody>
</table>
<h2>详细使用</h2>
<p>无论拿到扫描样子的题目第一步都是查看系统镜像，利用imageinfo查看详细镜像信息</p>
<p><code>vol.py -f 1.vmem imageinfo</code></p>
<pre><code class="language-shell">INFO    : volatility.debug    : Determining profile based on KDBG search...
          Suggested Profile(s) : Win7SP1x64, Win7SP0x64, Win2008R2SP0x64, Win2008R2SP1x64_23418, Win2008R2SP1x64, Win7SP1x64_23418
                     AS Layer1 : WindowsAMD64PagedMemory (Kernel AS)
                     AS Layer2 : FileAddressSpace (/home/neko/Desktop/1.vmem)
                      PAE type : No PAE
                           DTB : 0x187000L
                          KDBG : 0xf80003e520a0L
          Number of Processors : 1
     Image Type (Service Pack) : 1
                KPCR for CPU 0 : 0xfffff80003e53d00L
             KUSER_SHARED_DATA : 0xfffff78000000000L
           Image date and time : 2021-04-21 07:24:54 UTC+0000
     Image local date and time : 2021-04-21 15:24:54 +0800

</code></pre>
<p>通过查看Suggested Profile(s)字段确定需要使用的内存镜像分析配置文件</p>
<p><code>vol.py -f 1.vmem --profile=Win7SP1x64 pslist</code></p>
<pre><code class="language-shell">Volatility Foundation Volatility Framework 2.6
Offset(V)          Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                        
------------------ -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------
0xfffffa8018db89e0 System                    4      0     74      562 ------      0 2021-04-21 07:16:07 UTC+0000                               
0xfffffa801a449040 smss.exe                224      4      2       29 ------      0 2021-04-21 07:16:07 UTC+0000                               
0xfffffa801ab72b30 csrss.exe               308    300      9      473      0      0 2021-04-21 07:16:08 UTC+0000                               
0xfffffa8018dbd5f0 wininit.exe             344    300      3       75      0      0 2021-04-21 07:16:08 UTC+0000                               
0xfffffa801ab82060 csrss.exe               356    336      8      315      1      0 2021-04-21 07:16:08 UTC+0000                               
0xfffffa801abbf060 winlogon.exe            404    336      7      131      1      0 2021-04-21 07:16:08 UTC+0000                                 ..........
</code></pre>
<p>值得注意的是pid数字，可以通过它dump出内存中的程序</p>
<p><code>vol.py -f 1.vmem --profile=Win7SP1x64 procdump -p 224 -D ./</code></p>
<p>p：就是pid进程号</p>
<p>D：提取程序后保存的位置，./就是保存到当前位置</p>
<pre><code class="language-shell">Volatility Foundation Volatility Framework 2.6
Process(V)         ImageBase          Name                 Result
------------------ ------------------ -------------------- ------
0xfffffa801a449040 0x0000000048490000 smss.exe             OK: executable.224.exe
</code></pre>
<h3>检索终端信息</h3>
<p>vol中可以使用cmdscan扫描内存镜像中已经执行的cmd命令</p>
<p><code>vol.py -f 1.vmem --profile=Win7SP1x64 cmdscan</code></p>
<pre><code class="language-shell">Volatility Foundation Volatility Framework 2.6
**************************************************
CommandProcess: conhost.exe Pid: 3400
CommandHistory: 0x317540 Application: cmd.exe Flags: Allocated
CommandCount: 0 LastAdded: -1 LastDisplayed: -1
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0x5c
**************************************************
CommandProcess: conhost.exe Pid: 3400
CommandHistory: 0x317720 Application: csrss.exe Flags: Allocated
CommandCount: 0 LastAdded: -1 LastDisplayed: -1
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0x88
</code></pre>
<p>这个镜像并没有详细信息，可以看一下其他镜像</p>
<p><img src="https://camo.githubusercontent.com/174849bf730a63d69775ef2744ca8922dba97719f3da5435e1e2f7f1fd4fefa3/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f31613239346533333533353334643533616366626334643638313933353230332e706e67" alt="" /></p>
<h2>题目实例</h2>
<p>题目地址：https://ctf.show/challenges#JiaJia-CP-1-1734</p>
<p>详细：</p>
<pre><code>这是部分人熟知的**刘佳佳**同学的电脑，她今年21岁已在公司里实习。但是佳佳经常摸鱼被老板训斥说：&quot;你怎么摸得下去的&quot;。因此佳佳还会经常将未完成的工作带到家里去完成(~~老板不留她加班属实有点离谱~~。但最近佳佳一天摸鱼的时间达到了25小时，这令老板非常不爽。于是🐕老板悄悄的植入了一个软件并在后台获取了佳佳**电脑的内存信息**。由于老板也是个懒🐕于是叫你来找一下老板想要的佳佳电脑的信息。作为十年老粉的CTFer们如果不是因为要找到flag一定不想帮老板来看佳佳的电脑内存信息吧，于是你也只能来帮助老板寻找佳佳电脑里的信息。~~电脑里面没有奇奇怪怪的东西，不要乱翻浪费时间~~
题目解压密码：Th1s_15_p@SsW0rd_u_n3ver_kn0w_b3f0re_BLB_St4rt

可通过验证压缩包md5值查看附件是否损坏：de3b3febacdfa20d255e1014cd204a35

共3大题，第1大题做出来再给你第2大题和第3大题的题目，哼哼

1.佳佳的电脑用户名叫什么(即C:\Users\{name})

2.最后一次运行计算器的时间？(格式为yyyy-mm-dd_hh:mm:ss，注意冒号为英文冒号)

flag格式为ctfshow{md5(A1_A2)}， format:ctfshow{ljj_2021-12-12_07:13:26}=ctfshow{c3cf135599d338093cbd2b578065be89}**

google cloud链接https://drive.google.com/file/d/1UvMTUXV76F-qh1FGtUpE_duo3V7cgO1f/view

du盘链接https://pan.baidu.com/s/1hVFPJhU8B4g8Kyy0ssDSLw?pwd=show

提取码：show
</code></pre>
<p>先看题目，我们需要找出镜像文件中佳佳的用户名与最后一次运行计算机的时间，二者结合计算md5</p>
<p>先看第一题，需要我们找出Users下的佳佳的用户名，这里可以用到filescan插件配合grep输出来查询</p>
<p><code>vol.py -f JiaJia_Co.raw --profile=Win7SP1x64 filescan | grep Users</code></p>
<pre><code class="language-shell">0x000000013fdd8930     16      0 RW---- \Device\HarddiskVolume1\Users\JiaJia\AppData\Roaming\Telegram Desktop\Updater.exep
0x000000013fdda070     16      0 R--r-- \Device\HarddiskVolume1\Users\JiaJia\AppData\LocalLow\Microsoft\CryptnetUrlCache\MetaData\6025C34CC5B36C4156C40F3B0D99B6AB
0x000000013fde26a0     16      0 RW---- \Device\HarddiskVolume1\Users\JiaJia\AppData\Roaming\Telegram Desktop\Telegram.exe
0x000000013fde46d0      3      0 R--rw- \Device\HarddiskVolume1\Users\JiaJia\AppData\Local\Google\Chrome\User Data\Safe Browsing\UrlSoceng.store
0x000000013fde4930     16      0 R--r-- \Device\HarddiskVolume1\Users\JiaJia\AppData\LocalLow\Microsoft\CryptnetUrlCache\MetaData\F07644E38ED7C9F37D11EEC6D4335E02_E81D30836CB09660A7E3C5D921621623
0x000000013fded350     16      0 RW-rw- 
</code></pre>
<p><img src="https://picdm.sunbangyan.cn/2023/11/23/d61815de9a845dea4420fe8809ca84a4.jpeg" alt="" /></p>
<p>可知用户名为JiaJia</p>
<p>第二题需要我们找出计算器——也就是calc.exe，我之前的思路是查询pslist或者filescan过滤出calc字符，结果不行</p>
<p>pslist完全没有输出	filescan倒是有输出了但是没有时间信息</p>
<p><img src="https://picdl.sunbangyan.cn/2023/11/23/d71a8ffcc424d0b6f1c1af70621c863e.jpeg" alt="" /></p>
<p>后续在大佬的点拨下找到了这样一个命令</p>
<p><img src="https://picss.sunbangyan.cn/2023/11/23/444963a243f053b64eab22e9d1e6fc23.jpeg" alt="" /></p>
<p>timeliner可以梳理出内存中信息的时间线 配合过滤命令 就是</p>
<p><code>vol.py -f JiaJia_Co.raw --profile=Win7SP1x64 timeliner | grep calc.exe</code></p>
<p><img src="https://picss.sunbangyan.cn/2023/11/23/9d3d4593d99b481df96c6ebc46e2bd27.jpeg" alt="" /></p>
<p>得到时间信息：2021-12-10 12:15:47</p>
<p>但是因为windows和linux的差异时间相差了8个小时，也就是时间需要+8</p>
<p>因此正确时间应该是：2021-12-10 20:15:47</p>
<p>flag格式为ctfshow{md5(A1_A2)}， format:ctfshow{ljj_2021-12-12_07:13:26}=ctfshow{c3cf135599d338093cbd2b578065be89}</p>
<p>JiaJia_2021-20-10_20:15:47</p>
<p>ctfshow{JiaJia_2021-12-10_12:15:47}</p>
<p>ctfshow{079249e3fc743bc2d0789f224e451ffd}</p>
<p>正确通过。。。</p>
